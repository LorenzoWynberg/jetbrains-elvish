# Activity Log - 2026-01-21

## Summary
Completed STORY-105, STORY-106, and STORY-107: Added LSP integration tests for code completion, hover documentation, and diagnostics features.

---

## STORY-105: Test LSP code completion

### Changes Made
- [x] Created ElvishLspCompletionTest.kt with 5 tests for completion functionality
- [x] Created LspTestUtils.kt with shared utilities for LSP testing
- [x] Refactored ElvishLspIntegrationTest.kt to use shared utilities

### Files Modified
- `src/test/kotlin/com/elvish/plugin/lsp/ElvishLspCompletionTest.kt` - New file with 5 completion tests
- `src/test/kotlin/com/elvish/plugin/lsp/LspTestUtils.kt` - New file with shared LSP test utilities
- `src/test/kotlin/com/elvish/plugin/lsp/ElvishLspIntegrationTest.kt` - Refactored to use LspTestUtils

### Decisions Made
- Following same approach as STORY-104: writing automated integration tests rather than requiring manual GUI testing
- Tests communicate directly with `elvish -lsp` process using JSON-RPC protocol
- Extracted shared LSP test utilities to reduce duplication and keep file sizes under 300 lines

### Tests Added
1. `testVariableCompletion` - Verifies completion works when typing $
2. `testCommandCompletion` - Verifies completion for partial command names
3. `testModuleCompletion` - Verifies completion for module functions (e.g., str:)
4. `testCompletionHasDocumentation` - Verifies completion responses include signatures
5. `testSpecialVariableCompletion` - Verifies completion for special variables

### Refactoring Done
- Round 1: Extracted LspTestUtils.kt to share code between test files
- Round 2: Verified all files under 300 lines, no further changes needed

---

## STORY-106: Test LSP hover documentation

### Changes Made
- [x] Created ElvishLspHoverTest.kt with 5 tests for hover documentation functionality

### Files Modified
- `src/test/kotlin/com/elvish/plugin/lsp/ElvishLspHoverTest.kt` - New file with 5 hover tests

### Decisions Made
- Followed same approach as STORY-105: automated integration tests communicating directly with `elvish -lsp`
- Tests use the `textDocument/hover` LSP method to verify hover functionality
- Added test for response time (<1 second) per acceptance criteria

### Tests Added
1. `testHoverOverBuiltinFunction` - Verifies hover works over built-in functions (echo)
2. `testHoverOverPutFunction` - Verifies hover works over the 'put' function
3. `testHoverOverVariable` - Verifies hover shows info for variable references
4. `testHoverResponseTime` - Verifies hover responds within 1 second
5. `testHoverOverModuleFunction` - Verifies hover works for module functions (str:join)

### Refactoring Done
- Round 1: All files under 300 lines, no changes needed
- Round 2: Double-checked organization, no issues found

---

## STORY-107: Test LSP diagnostics

### Changes Made
- [x] Created ElvishLspDiagnosticsTest.kt with 6 tests for diagnostics functionality
- [x] Extended LspTestUtils.kt with additional shared utilities (sendRequest, sendNotification, waitForNotification, shutdown)

### Files Modified
- `src/test/kotlin/com/elvish/plugin/lsp/ElvishLspDiagnosticsTest.kt` - New file with 6 diagnostics tests
- `src/test/kotlin/com/elvish/plugin/lsp/LspTestUtils.kt` - Added shared helper methods

### Decisions Made
- Followed same approach as STORY-105/106: automated integration tests communicating directly with `elvish -lsp`
- Tests use the `textDocument/publishDiagnostics` notification to verify diagnostics functionality
- Added `waitForNotification` to LspTestUtils for waiting on server-pushed notifications

### Tests Added
1. `testSyntaxErrorDiagnostics` - Verifies diagnostics appear for unclosed brace
2. `testUnclosedBracketDiagnostics` - Verifies diagnostics for unclosed bracket
3. `testDiagnosticsContainErrorMessage` - Verifies error messages in diagnostics
4. `testFixingErrorClearsDiagnostics` - Verifies diagnostics update when errors are fixed
5. `testRealTimeDiagnosticsUpdate` - Verifies diagnostics update in real-time (< 2 seconds)
6. `testUndefinedVariableDiagnostics` - Tests diagnostics for undefined variable references

### Refactoring Done
- Round 1: Extracted common helpers (sendRequest, sendNotification, shutdown, waitForNotification) to LspTestUtils - reduced diagnostics test from 328 to 260 lines
- Round 2: Verified all files under 300 lines, no additional changes needed

---

## Next Steps
- STORY-108: Add error handling for missing Elvish binary
